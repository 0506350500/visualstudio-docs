---
title: "CA5392: Use DefaultDllImportSearchPaths attribute for P/Invokes"
description: Provides information about code analysis rule CA5392, including causes, how to fix violations, and when to suppress it.
ms.date: 05/28/2020
ms.topic: reference
author: LLLXXXCCC
ms.author: linche
manager: jillfra
ms.workload:
  - "multiple"
f1_keywords:
  - "CA5392"
---
# CA5392: Use DefaultDllImportSearchPaths attribute for P/Invokes

|||
|-|-|
|CheckId|CA5392|
|Category|Microsoft.Security|
|Breaking change|Non-breaking|

## Cause

The <xref:System.Runtime.InteropServices.DefaultDllImportSearchPathsAttribute?displayProperty=fullName> is not specified for P/Invokes while importing the 3rd dll.

## Rule description

By default, P/Invokes using <xref:System.Runtime.InteropServices.DllImportAttribute?displayProperty=fullName> probe a number of directories, including the current working directory for the library to load. Then a malicious dll whose name is as same as the real one is somehow put under the currenty working directory, which will be searched firstly by default, it will be loaded and the file owner, the attacker, can do what ever he wants to do. This can be a security issue for certain applications, leading to DLL hijacking.

## How to fix violations

Use <xref:System.Runtime.InteropServices.DefaultDllImportSearchPaths> to specify the dll search path explicitly for the assembly or the method.

## When to suppress warnings

It's safe to suppress this rule if:
- You're sure the loaded assembly is what you want.
- The imported assembly is a commonly used system assembly, like user32.dll, and the search path strategy follows the Known Dlls mechanism.

## Pseudo-code examples

```csharp
using System;
using System.Runtime.InteropServices;

class ExampleClass
{
    [DllImport("The3rdAssembly.dll")]
    public static extern int MessageBox(IntPtr hWnd, String text, String caption, uint type);

    public void ExampleMethod()
    {
        MessageBox(new IntPtr(0), "Hello World!", "Hello Dialog", 0);
    }
}
```

### Solution

```csharp
using System;
using System.Runtime.InteropServices;

class ExampleClass
{
    [DllImport("The3rdAssembly.dll")]
    [DefaultDllImportSearchPaths(DllImportSearchPath.UserDirectories)]
    public static extern int MessageBox(IntPtr hWnd, String text, String caption, uint type);

    public void ExampleMethod()
    {
        MessageBox(new IntPtr(0), "Hello World!", "Hello Dialog", 0);
    }
}
```

## Related rules

[CA5393: Do not use unsafe DllImportSearchPath value](ca5393.md)
