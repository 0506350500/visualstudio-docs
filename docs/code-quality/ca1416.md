---
title: "ca1416: Validate platform compatibility"
ms.date: 09/01/2020
ms.topic: reference
f1_keywords:
  - "PlatformCompatibilityAnalyzer"
  - "CA1416"
helpviewer_keywords:
  - "PlatformCompatibilityAnalyzer"
  - "CA1416"
author: buyaa-n
ms.author: bunamnan
manager: jeffhand
ms.workload:
  - "multiple"
---
# CA1416: Validate platform compatibility;

|||
|-|-|
|CheckId|CA1416|
|Category|Microsoft.Interoperability|
|Breaking change|Non-breaking|

## Cause

Using platform-dependent APIs on a component makes the code no longer work across all platforms. Developers could get diagnostics when they
- unintentionally using a platform-specific APIs from platform-neutral context or from different platform without proper platform guards
- accidentally using an API that is unsupported for the targeted platform

## Rule description

In .NET 5.0 we have added new attributes to annotate platform-specific APIs. This works as follows:
- An unmarked API is considered to work on all OS platforms.
- An API marked with `[SupportedOSPlatform("platformName")]` is considered only portable to the specified OS platforms (the attribute can be applied multiple times with different platforms).
- An API marked with `[UnsupportedOSPlatform("platformName")]` is considered unsupported only to the specified OS platforms (the attribute can be applied multiple times with different platforms).
- If combination of `[SupportedOSPlatform] and [UnsupportedOSPlatform]` attributes are present, we group all attributes by OS platform identifier:
  - Allow list. If the lowest version for each OS platform is a `[SupportedOSPlatform]` attribute, the API is considered to only be supported by the listed platforms and unsupported by all other platforms. The list could have `[UnsupportedOSPlatform]` attribute with same platform but only with higher version which denotes that the API is removed from that version.
  - Deny list. If the lowest version for each OS platform is a `[UnsupportedOSPlatform]` attribute, then the API is considered to only be unsupported by the listed platforms and supported by all other platforms. The list could have `[SupportedOSPlatform]` attribute with same platform but only with higher version which denotes that the API is added support from that version.
  - Inconsistent list. If for some platforms the lowest version attribute is `[SupportedOSPlatform]` while for others it is `[UnsupportedOSPlatform]`, is considered inconsistent, so annotations ignored. We will introduce another analyzer producing a warning in case of inconsistency.
- Both attributes can be instantiated with or without version numbers. Version less attribute means the version number is assumed to be 0.0. This simplifies guard clauses, see examples below for more details.

### Examples
- Accessing an API that is annotated as only supported on a platform (`[SupportedOSPlatform("platformName")]`) from platform-neutral or non `platformName` specific context could produce a diagnostic: `'API' is supported on 'platformName'.`

```csharp
// an API supported only on linux
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { }

// an API supported on windows and ios from version 14.0
[SupportedOSPlatform("windows")]
[SupportedOSPlatform("ios14.0")]
public void SupportedOnWindowsAndIos14() { }

```

> [!NOTE]
> A diagnostic is only raised if the project is targeting `net5.0` and has an AnalysisLevel of 5 (the default for `net5.0` projects). This also applies to multi-targeted projects. No diagnostic is raised if the project is targeting the platform specified (`net5.0-platformName`), or if you are targeting `netstandard` or `netcoreapp`.

- Accessing an API that is attributed with `[UnsupportedOSPlatform("platformName")]` from the context that targeting the platform with `platformName` could produce a diagnostic: `'API' is unsupported on 'platformName'.`

```csharp
// an API not supported on android but supported on all other
[UnsupportedOSPlatform("android")] 
public void DoesNotWorkOnAndroid() { }

// an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void StartedWindowsSupportFromCertainVersion();
```

> [!NOTE]
> If you're building an app that is not targeting the unsupported platform, you won't get any diagnostics. This only raises a diagnostic if the project is targeting the platform attributed as unsupported or the `platformName` is included in the default `MSBuild` `<SupportedPlatform>` items group, or manually including the `platformName` in the MSBuild `<SupportedPlatform>` items group:

```XML
<ItemGroup>
    <SupportedPlatform Include="platformName" />
</ItemGroup>
```

## How to fix violations

The recommend way to deal with these diagnostics is by making sure you only call these APIs when running on the appropriate platforms. You can either achieve this by excluding the code at build time using #if and multi-targeting or by conditionally calling the code at runtime. The analyzer will recognize the new platform guards we added to <xref:System.OperatingSystem> that you can use for checking.

- Suppress diagnostics by surrounding the call site with the platform guard methods

```csharp
// an API supported only on linux
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { }  

// an API supported on windows and ios from version 14.0
[SupportedOSPlatform("windows")]
[SupportedOSPlatform("ios14.0")]
public void SupportedOnWindowsAndIos14() { }  
                                              
public void Test()
{
    LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
    SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                  // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
}


public void Test()
{
    if (OperatingSystem.IsLinux())
    {
        LinuxOnlyApi(); // no diagnostic
    }

    if (OperatingSystem.IsIOSVersionAtLeast(14))
    {
        SupportedOnWindowsAndIos14(); // no diagnostic
    }
}

// an API not supported on android but supported on all other
[UnsupportedOSPlatform("android")]  
public void DoesNotWorkOnAndroid() { }

// an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void StartedWindowsSupportFromCertainVersion();

public void Test()
{
    DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
    StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                               // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
}

public void Test()
{
    if (!OperatingSystem.IsAndroid())
    {
        DoesNotWorkOnAndroid(); // no diagnostic
    }

    // Can use &&, || logical operators to guard combined attributes
    if (!OperatingSystem.IsWindows() || OperatingSystem.IsWindowsVersionAtLeast(10, 0, 1903))
    {
        StartedWindowsSupportFromCertainVersion(); // no diagnostic
    }
}

```

- The analyzer also respects `Debug.Assert` as a means for preventing the code from being reached on unsupported platforms. Using Debug.Assert allows the check to be trimmed out of release builds if desired.

```csharp
// an API supported only on linux
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { } 

public void Test() 
{
    Debug.Assert(OperatingSystem.IsLinux());

    LinuxOnlyApi(); // No diagnostic
} 
```

- You can choose to mark your own APIs as being platform-specific, thus effectively just forwarding the requirements to your callers. You can only mark specific methods or types or the entire assembly.

```csharp
[SupportedOSPlatform("windows")]
[SupportedOSPlatform("ios14.0")]
public void SupportedOnWindowsAndIos14() { }  

[SupportedOSPlatform("ios15.0")] // call site version should be equal to or higher than the API version
public void Test() 
{ 
    StartedWindowsSupportFromCertainVersion(); // No diagnostics
} 
```

```csharp
[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void StartedWindowsSupportFromCertainVersion();

[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void Test() 
{ 
    StartedWindowsSupportFromCertainVersion(); // No diagnostics
} 
```

## When to suppress warnings

Referencing platform-specific APIs without a proper platform context/guard is not recommended. But if needed you can suppress these diagnostics by the usual means (`<NoWarn>`, editor config, or #pragma):

```csharp
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { } 

public void Test() 
{ 
#pragma warning disable CA1416
    LinuxOnlyApi(); 
#pragma warning restore CA1416
} 
```

## See also

- [Interoperability warnings](/dotnet/framework/interop/index)
