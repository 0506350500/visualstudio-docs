---
title: "ca1416: Validate platform compatibility"
ms.date: 09/01/2020
ms.topic: reference
f1_keywords:
  - "PlatformCompatibilityAnalyzer"
  - "CA1416"
helpviewer_keywords:
  - "PlatformCompatibilityAnalyzer"
  - "CA1416"
author: buyaa-n
ms.author: bunamnan
manager: jeffhandley
ms.workload:
  - "multiple"
---
# CA1416: Validate platform compatibility;

|||
|-|-|
|CheckId|CA1416|
|Category|Microsoft.Interoperability|
|Breaking change|Non-breaking|

## Cause

Using platform-dependent APIs on a component makes the code no longer work across all platforms. Developers could get diagnostics when they
- unintentionally use a platform-specific API from platform-neutral context or from a different platform without proper platform guards
- accidentally use an API that is unsupported for the targeted platform

## Rule description

In .NET 5.0 we have added new attributes to annotate platform-specific APIs. This works as follows:
- An unmarked API is considered to work on all OS platforms.
- An API marked with `[SupportedOSPlatform("platformName")]` is considered only portable to the specified OS platforms (the attribute can be applied multiple times with different platforms).
- An API marked with `[UnsupportedOSPlatform("platformName")]` is considered unsupported only to the specified OS platforms (the attribute can be applied multiple times with different platforms).
- Both attributes can be instantiated with or without version numbers as part of the platform name. Platform names without versions assume a version of 0.0. This simplifies guard clauses, see examples below for more details.
  - Version numbers are in the format of `major.minor[.build[.revision]]`; `major.minor` is required and the `build` and `revision` parts are optional.
  - For example, "windows7.0" indicates Windows version 7.0, but "windows" is interpreted as Windows 0.0.
- If a combination of `[SupportedOSPlatform] and [UnsupportedOSPlatform]` attributes are present, we group all attributes by OS platform identifier:
  - **Allow list**. If the lowest version for each OS platform is a `[SupportedOSPlatform]` attribute, the API is considered to only be supported by the listed platforms and unsupported by all other platforms. The list could have `[UnsupportedOSPlatform]` attribute with same platform but only with higher version which denotes that the API is removed from that version.
  - **Deny list**. If the lowest version for each OS platform is an `[UnsupportedOSPlatform]` attribute, then the API is considered to only be unsupported by the listed platforms and supported by all other platforms. The list could have `[SupportedOSPlatform]` attribute with same platform but only with higher version which denotes that the API is added support from that version.
  - **Inconsistent list**. If the lowest version for some platforms is `[SupportedOSPlatform]` while it is `[UnsupportedOSPlatform]` for other platforms, is considered inconsistent, and the some annotations on the API are ignored. We plan to introduce another analyzer producing a warning in case of inconsistency in the future.

### Examples
- Accessing an API that is supported only on specified platform (`[SupportedOSPlatform("platformName")]`) from code reachable on other platforms will produce a diagnostic: `'API' is supported on 'platformName'.`

```csharp
// an API supported only on linux
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { }

// an API supported on windows and ios from version 14.0
[SupportedOSPlatform("windows")]
[SupportedOSPlatform("ios14.0")]
public void SupportedOnWindowsAndIos14() { }

public void Caller()
{
    LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
    SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                  // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
}

```

> [!NOTE]
> A diagnostic is only raised if the project is targeting `net5.0` and has an AnalysisLevel of 5 (the default for `net5.0` projects). This also applies to multi-targeted projects. No diagnostic is raised if the project is targeting the platform specified (`net5.0-platformName`), or if you are targeting `netstandard` or `netcoreapp`.

- Accessing an API that is attributed with `[UnsupportedOSPlatform("platformName")]` from the context that targeting the platform with `platformName` could produce a diagnostic: `'API' is unsupported on 'platformName'.`

```csharp
// an API not supported on android but supported on all other
[UnsupportedOSPlatform("android")] 
public void DoesNotWorkOnAndroid() { }

// an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void StartedWindowsSupportFromCertainVersion();

public void Caller()
{
    DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
    StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                               // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
}
```

> [!NOTE]
> If you're building an app that is not targeting the unsupported platform, you won't get any diagnostics. This only raises a diagnostic if the project is targeting the platform attributed as unsupported or the `platformName` is included in the default `MSBuild` `<SupportedPlatform>` items group, or manually including the `platformName` in the MSBuild `<SupportedPlatform>` items group:

```XML
<ItemGroup>
    <SupportedPlatform Include="platformName" />
</ItemGroup>
```

## How to fix violations

The recommended way to deal with these diagnostics is by making sure you only call these APIs when running on the appropriate platforms. You can either achieve this by excluding the code at build time using #if and multi-targeting or by conditionally calling the code at runtime. The analyzer will recognize the new platform guards we added to <xref:System.OperatingSystem> along with traditional <xref:System.Runtime.InteropServices.RuntimeInformation.IsOSPlatform%2A?displayProperty=fullName> that you can use for checking. 

- Suppress diagnostics by surrounding the call site with the platform guard methods

```csharp
// an API supported only on linux
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { }  

// an API supported on windows and ios from version 14.0
[SupportedOSPlatform("windows")]
[SupportedOSPlatform("ios14.0")]
public void SupportedOnWindowsAndIos14() { }  
                                              
public void Caller()
{
    LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
    SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                  // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
}

// The diagnostics fixed using platform guard methods
public void Caller()
{
    if (OperatingSystem.IsLinux())
    {
        LinuxOnlyApi(); // no diagnostic
    }

    if (OperatingSystem.IsIOSVersionAtLeast(14))
    {
        SupportedOnWindowsAndIos14(); // no diagnostic
    }

    if(RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
    {
        SupportedOnWindowsAndIos14(); // no diagnostic
    }
}

// an API not supported on android but supported on all other
[UnsupportedOSPlatform("android")]  
public void DoesNotWorkOnAndroid() { }

// an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void StartedWindowsSupportFromCertainVersion();

public void Caller()
{
    DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
    StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                               // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
}

public void Caller()
{
    if (!OperatingSystem.IsAndroid())
    {
        DoesNotWorkOnAndroid(); // no diagnostic
    }

    // Can use &&, || logical operators to guard combined attributes
    if (!OperatingSystem.IsWindows() || OperatingSystem.IsWindowsVersionAtLeast(10, 0, 1903))
    {
        StartedWindowsSupportFromCertainVersion(); // no diagnostic
    }
}

```

- The analyzer also respects `Debug.Assert` as a means for preventing the code from being reached on unsupported platforms. Using Debug.Assert allows the check to be trimmed out of release builds if desired.

```csharp
// an API supported only on linux
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { } 

public void Caller() 
{
    Debug.Assert(OperatingSystem.IsLinux());

    LinuxOnlyApi(); // No diagnostic
} 
```

- You can choose to mark your own APIs as being platform-specific, thus effectively just forwarding the requirements to your callers. You can only mark specific methods or types or the entire assembly.

```csharp
[SupportedOSPlatform("windows")]
[SupportedOSPlatform("ios14.0")]
public void SupportedOnWindowsAndIos14() { }  

[SupportedOSPlatform("ios15.0")] // call site version should be equal to or higher than the API version
public void Caller() 
{ 
    SupportedOnWindowsAndIos14(); // No diagnostics
} 

[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void StartedWindowsSupportFromCertainVersion();

[UnsupportedOSPlatform("windows")]
[SupportedOSPlatform("windows10.0.1903")]
public void Caller() 
{ 
    StartedWindowsSupportFromCertainVersion(); // No diagnostics
} 
```

Assembly level attribute applied, s all members within the assembly are platform specific

```csharp
[assembly:SupportedOSPlatform("windows")]
public namespace ns
{
    public class Sample
    {
        public void SupportedOnWindows() { }  
        
        public void Caller() 
        { 
            SupportedOnWindows(); // No diagnostic as call site and calling method both windows only
        }
    }
} 
```

## When to suppress warnings

Referencing platform-specific APIs without a proper platform context/guard is not recommended. But if needed you can suppress these diagnostics by the usual means (`<NoWarn>`, editor config, or #pragma):

```csharp
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { } 

public void Caller() 
{ 
#pragma warning disable CA1416
    LinuxOnlyApi(); 
#pragma warning restore CA1416
} 
```

## See also

- [Annotating platform-specific APIs and detecting its use](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-checks/platform-checks.md)
- [Annotating APIs as unsupported on specific platforms](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-exclusion/platform-exclusion.md)
- [Target Framework Names in .NET 5](https://github.com/dotnet/designs/blob/master/accepted/2020/net5/net5.md)
- [.NET API analyzer](https://docs.microsoft.com/dotnet/standard/analyzers/api-analyzer)
- [Interoperability warnings](/dotnet/framework/interop/index)